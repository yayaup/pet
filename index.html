<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å® ç‰©ï¼šæ˜Ÿç«çµ (SparkPet)</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Zcool+KuaiLe&family=Nunito:wght@400;700&display=swap');

        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, #1a1c2c 0%, #4a192c 100%);
            color: #fff;
            overflow-x: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            /* Mobile safe area fix */
            padding-bottom: env(safe-area-inset-bottom);
        }

        h1, h2, h3 {
            font-family: 'Zcool KuaiLe', cursive, sans-serif;
        }

        /* å® ç‰©åŠ¨ç”» */
        .pet-container {
            transition: all 0.3s ease;
            position: relative;
        }
        
        /* èŠå¤©æ°”æ³¡åŠ¨ç”» */
        .chat-bubble {
            opacity: 0;
            transform: translateY(10px) translateX(-50%);
            transition: all 0.3s ease;
        }
        .chat-bubble.show {
            opacity: 1;
            transform: translateY(0) translateX(-50%);
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        .anim-bounce { animation: bounce 0.5s ease; }

        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .anim-shake { animation: shake 0.5s; }

        @keyframes pulse-sleep {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        .anim-sleep { animation: pulse-sleep 2s infinite ease-in-out; filter: grayscale(50%); }

        @keyframes evolve-glow {
            0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(255, 215, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
        }
        .evolving { animation: evolve-glow 1s infinite; }

        /* é˜¶æ®µå…‰ç¯ç‰¹æ•ˆ */
        .aura-stage-1 { filter: drop-shadow(0 0 5px rgba(255,255,255,0.5)); } /* è›‹ */
        .aura-stage-2 { filter: drop-shadow(0 0 8px rgba(255, 255, 0, 0.6)); } /* å¹¼å¹´ */
        .aura-stage-3 { filter: drop-shadow(0 0 12px rgba(255, 100, 0, 0.7)); } /* æˆé•¿ */
        .aura-stage-4 { filter: drop-shadow(0 0 20px rgba(255, 0, 200, 0.8)); } /* ç©¶æ */

        /* è¿›åº¦æ¡æ ·å¼ */
        .bar-container {
            background: rgba(0,0,0,0.5);
            border-radius: 999px;
            overflow: hidden;
            height: 12px;
            width: 100%;
            position: relative;
        }
        .bar-fill {
            height: 100%;
            transition: width 0.5s ease-out;
            border-radius: 999px;
        }

        /* æŒ‰é’®ç‰¹æ•ˆ */
        .btn-action {
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .btn-action:active {
            transform: scale(0.95);
        }
        .btn-disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
            filter: grayscale(100%);
        }

        /* æµ®åŠ¨æ–‡å­— */
        .floater {
            position: absolute;
            animation: floatUp 1s forwards;
            pointer-events: none;
            font-weight: bold;
            text-shadow: 1px 1px 2px black;
        }
        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-50px); opacity: 0; }
        }

        /* æˆ˜æ–—æ—¥å¿—åŒºåŸŸ */
        .log-area::-webkit-scrollbar {
            width: 6px;
        }
        .log-area::-webkit-scrollbar-thumb {
            background-color: rgba(255,255,255,0.2);
            border-radius: 4px;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

    <!-- Game Container -->
    <div class="w-full max-w-md bg-white/10 backdrop-blur-md border border-white/20 rounded-3xl shadow-2xl overflow-hidden relative mt-4 mb-4">
        
        <!-- Header -->
        <div class="p-4 bg-black/20 text-center flex justify-between items-center">
            <div class="text-left">
                <h1 class="text-xl text-yellow-400 tracking-wider">æ˜Ÿç«çµ SparkPet</h1>
                <div class="text-xs text-gray-300 mt-1">Lv.<span id="level-display">1</span> <span id="stage-name" class="bg-white/10 px-2 py-0.5 rounded-full ml-1">å¹¼å¹´ä½“</span></div>
            </div>
            <div class="text-right">
                <button onclick="toggleSound()" class="text-gray-400 hover:text-white transition p-2"><i class="fas fa-volume-up"></i></button>
            </div>
        </div>

        <!-- Main Pet View -->
        <div class="relative h-72 flex items-center justify-center bg-gradient-to-b from-transparent to-black/30">
            <!-- Chat Bubble -->
            <div id="chat-bubble" class="chat-bubble absolute top-8 left-1/2 bg-white text-gray-800 px-4 py-2 rounded-2xl rounded-bl-sm shadow-xl text-sm font-bold z-20 whitespace-nowrap pointer-events-none">
                ä¸»äººï¼Œä½ å¥½å‘€ï¼ğŸ‘‹
            </div>

            <!-- Pet Emoji -->
            <div id="pet" class="text-9xl cursor-pointer pet-container select-none transform transition-transform aura-stage-1 mt-8" onclick="petClick()">
                ğŸ¥š
            </div>
            
            <!-- Sleep Zzz Overlay -->
            <div id="sleep-overlay" class="absolute top-10 right-10 hidden">
                <div class="text-4xl font-bold text-blue-200 animate-pulse">Zzz...</div>
            </div>

            <!-- Effects Container (for floaters) -->
            <div id="effects-layer" class="absolute inset-0 pointer-events-none overflow-hidden"></div>
        </div>

        <!-- Stats Panel - Optimized for Mobile -->
        <div class="p-5 space-y-3 bg-black/20">
            <!-- HP -->
            <div class="flex items-center gap-3 text-sm">
                <i class="fas fa-heart text-red-500 w-5 text-center"></i>
                <div class="bar-container h-3">
                    <div id="bar-hp" class="bar-fill bg-red-500" style="width: 100%;"></div>
                </div>
                <span id="text-hp" class="w-10 text-right text-xs font-mono opacity-80">100</span>
            </div>
            <!-- Hunger -->
            <div class="flex items-center gap-3 text-sm">
                <i class="fas fa-drumstick-bite text-orange-500 w-5 text-center"></i>
                <div class="bar-container h-3">
                    <div id="bar-hunger" class="bar-fill bg-orange-500" style="width: 100%;"></div>
                </div>
                <span id="text-hunger" class="w-10 text-right text-xs font-mono opacity-80">100</span>
            </div>
            <!-- Energy -->
            <div class="flex items-center gap-3 text-sm">
                <i class="fas fa-bolt text-yellow-400 w-5 text-center"></i>
                <div class="bar-container h-3">
                    <div id="bar-energy" class="bar-fill bg-yellow-400" style="width: 100%;"></div>
                </div>
                <span id="text-energy" class="w-10 text-right text-xs font-mono opacity-80">100</span>
            </div>
            <!-- XP -->
            <div class="flex items-center gap-3 text-sm">
                <i class="fas fa-star text-purple-400 w-5 text-center"></i>
                <div class="bar-container bg-gray-700 h-3">
                    <div id="bar-xp" class="bar-fill bg-purple-500" style="width: 0%;"></div>
                </div>
                <span id="text-xp" class="w-10 text-right text-xs font-mono opacity-80">0%</span>
            </div>
        </div>

        <!-- Action Buttons - Touch Friendly -->
        <div class="p-4 grid grid-cols-2 gap-4 bg-black/40 pb-6">
            <button id="btn-feed" onclick="game.feed()" class="btn-action bg-gradient-to-br from-orange-500 to-orange-700 active:from-orange-700 active:to-orange-800 text-white py-4 rounded-2xl font-bold flex flex-col items-center gap-1 shadow-lg border-b-4 border-orange-900 active:border-b-0 active:translate-y-1">
                <i class="fas fa-utensils text-2xl mb-1"></i>
                <span>å–‚é£Ÿ</span>
                <span class="text-[10px] font-normal opacity-70">+20 é¥±é£Ÿ</span>
            </button>
            <button id="btn-train" onclick="game.train()" class="btn-action bg-gradient-to-br from-blue-500 to-blue-700 active:from-blue-700 active:to-blue-800 text-white py-4 rounded-2xl font-bold flex flex-col items-center gap-1 shadow-lg border-b-4 border-blue-900 active:border-b-0 active:translate-y-1">
                <i class="fas fa-dumbbell text-2xl mb-1"></i>
                <span>è®­ç»ƒ</span>
                <span class="text-[10px] font-normal opacity-70">-20 ç²¾åŠ›</span>
            </button>
            <button id="btn-sleep" onclick="game.sleep()" class="btn-action bg-gradient-to-br from-indigo-500 to-indigo-700 active:from-indigo-700 active:to-indigo-800 text-white py-4 rounded-2xl font-bold flex flex-col items-center gap-1 shadow-lg border-b-4 border-indigo-900 active:border-b-0 active:translate-y-1">
                <i class="fas fa-bed text-2xl mb-1"></i>
                <span>ç¡è§‰</span>
                <span class="text-[10px] font-normal opacity-70">æ¢å¤ç²¾åŠ›</span>
            </button>
            <button id="btn-battle" onclick="game.startBattle()" class="btn-action bg-gradient-to-br from-red-500 to-red-700 active:from-red-700 active:to-red-800 text-white py-4 rounded-2xl font-bold flex flex-col items-center gap-1 shadow-lg border-b-4 border-red-900 active:border-b-0 active:translate-y-1">
                <i class="fas fa-khanda text-2xl mb-1"></i>
                <span>æˆ˜æ–—</span>
                <span class="text-[10px] font-normal opacity-70">å†’é™©</span>
            </button>
        </div>

        <!-- Game Log (Console) -->
        <div class="bg-black/80 h-32 p-3 text-xs font-mono text-green-400 overflow-y-auto log-area border-t border-white/10" id="game-log">
            <div>> ç³»ç»Ÿå¯åŠ¨æˆåŠŸ...</div>
            <div>> æ¬¢è¿æ¥åˆ°æ˜Ÿç«çµä¸–ç•Œï¼</div>
        </div>
    </div>

    <!-- Battle Modal Overlay -->
    <div id="battle-modal" class="fixed inset-0 bg-black/90 z-50 hidden flex flex-col items-center justify-center p-4">
        <h2 class="text-3xl text-red-500 font-bold mb-4 animate-pulse">âš”ï¸ æˆ˜æ–—ä¸­ âš”ï¸</h2>
        <div class="w-full max-w-sm bg-gray-800 rounded-lg p-4 border border-gray-600">
            <div class="flex justify-between items-center mb-6">
                <div class="text-center">
                    <div id="battle-player-icon" class="text-4xl mb-2">ğŸ£</div>
                    <div class="text-sm font-bold text-green-400">æˆ‘æ–¹</div>
                    <div class="w-16 h-2 bg-gray-700 rounded-full mt-1"><div id="battle-player-hp" class="h-full bg-green-500 rounded-full" style="width: 100%"></div></div>
                </div>
                <div class="text-2xl text-yellow-500 font-bold">VS</div>
                <div class="text-center">
                    <div id="battle-enemy-icon" class="text-4xl mb-2">ğŸ•·ï¸</div>
                    <div class="text-sm font-bold text-red-400">æ•Œäºº</div>
                    <div class="w-16 h-2 bg-gray-700 rounded-full mt-1"><div id="battle-enemy-hp" class="h-full bg-red-500 rounded-full" style="width: 100%"></div></div>
                </div>
            </div>
            <div id="battle-log" class="h-32 overflow-y-auto bg-black/50 p-2 rounded text-xs text-gray-300 font-mono mb-4">
                æˆ˜æ–—å¼€å§‹...
            </div>
            <button id="battle-close-btn" onclick="game.endBattleUI()" class="w-full bg-gray-600 text-white py-2 rounded hidden">å…³é—­</button>
        </div>
    </div>

    <!-- Reset Modal -->
    <div id="death-modal" class="fixed inset-0 bg-red-900/90 z-50 hidden flex flex-col items-center justify-center">
        <div class="text-6xl mb-4">ğŸ‘»</div>
        <h2 class="text-3xl font-bold mb-2">æ˜Ÿç«çµå€’ä¸‹äº†</h2>
        <p class="mb-6 text-gray-300">è¯·ç…§é¡¾å¥½ä½ çš„å® ç‰©...</p>
        <button onclick="location.reload()" class="bg-white text-red-900 px-6 py-2 rounded-full font-bold hover:scale-105 transition">é‡æ–°å¼€å§‹</button>
    </div>

    <script>
        // Game Configuration
        const CONFIG = {
            tickRate: 1000, 
            hungerDecay: 0.8, // Slightly increased decay for mobile engagement
            energyDecay: 0.5, 
            sleepDuration: 5000, 
            baseAttack: 10,
            xpToLevel: 100
        };
        
        // Cute Phrases Database
        const PHRASES = {
            hungry: ["ä¸»äººï¼Œé¥¿é¥¿~ ğŸ–", "è‚šå­å’•å’•å«äº†...", "ä¸ä»…è¦åƒç©ºæ°”ï¼Œè¿˜è¦åƒé¥­é¥­ï¼"],
            tired: ["å¥½å›°å‘€... ğŸ’¤", "çœ¼çš®æ‰“æ¶äº†...", "ä¸è®ºå¦‚ä½•ï¼Œå…ˆç¡ä¸€è§‰å§..."],
            bored: ["é™ªæˆ‘ç©å˜›ï¼ğŸ¥º", "å‘å‘†ä¸­...", "ä»Šå¤©å¤©æ°”çœŸå¥½ï¼ˆå¤§æ¦‚ï¼‰", "æƒ³è¦å˜å¼ºï¼ğŸ’ª", "çœ‹æˆ‘å¯çˆ±çš„çœ¼ç¥ âœ¨", "å•¾å•¾å•¾~"],
            battle: ["å†²å•Šï¼âš”ï¸", "ä¸ºäº†ä¸»äººçš„è£è€€ï¼", "çœ‹æ‹›ï¼"],
            evolve: ["æ„Ÿè§‰èº«ä½“å……æ»¡äº†åŠ›é‡ï¼ğŸ”¥", "æˆ‘åœ¨å‘å…‰è€¶ï¼"]
        };

        // DOM Elements
        // FIX: Ensure all elements accessed in updateUI are defined here
        const ui = {
            pet: document.getElementById('pet'),
            chatBubble: document.getElementById('chat-bubble'),
            log: document.getElementById('game-log'),
            buttons: document.querySelectorAll('.btn-action'),
            
            // Bars and Text
            hpBar: document.getElementById('bar-hp'),
            hpText: document.getElementById('text-hp'),
            hungerBar: document.getElementById('bar-hunger'),
            hungerText: document.getElementById('text-hunger'),
            energyBar: document.getElementById('bar-energy'),
            energyText: document.getElementById('text-energy'),
            xpBar: document.getElementById('bar-xp'),
            xpText: document.getElementById('text-xp'),
            
            // Status
            level: document.getElementById('level-display'),
            stage: document.getElementById('stage-name'),
            
            // Overlays
            sleepOverlay: document.getElementById('sleep-overlay'),
            battleModal: document.getElementById('battle-modal'),
            battleLog: document.getElementById('battle-log'),
            battleClose: document.getElementById('battle-close-btn'),
            effects: document.getElementById('effects-layer'),
            deathModal: document.getElementById('death-modal')
        };

        // Game Logic Class
        class Game {
            constructor() {
                this.state = {
                    hp: 100, maxHp: 100,
                    hunger: 80, maxHunger: 100,
                    energy: 80, maxEnergy: 100,
                    xp: 0,
                    level: 1,
                    strength: 5,
                    isSleeping: false,
                    inBattle: false,
                    isDead: false
                };
                
                this.timer = null;
                this.idleTimer = null;
                this.init();
            }

            init() {
                this.updateUI();
                this.timer = setInterval(() => this.tick(), CONFIG.tickRate);
                
                // Start AI loop
                this.idleTimer = setInterval(() => this.aiLoop(), 6000); // Check every 6 seconds
                
                this.log("æ˜Ÿç«çµå­µåŒ–äº†ï¼è®°å¾—å–‚é£Ÿå“¦ã€‚");
                this.speak("ä¸»äººï¼Œè¯·å¤šå…³ç…§ï¼");
            }

            // AI Behavior Loop (Personality)
            aiLoop() {
                if(this.state.isDead || this.state.isSleeping || this.state.inBattle) return;
                
                // 30% chance to do something when idle
                if(Math.random() < 0.3) {
                    this.triggerRandomEvent();
                }
            }

            triggerRandomEvent() {
                // Priority: Hungry > Tired > Bored
                let mood = "bored";
                if(this.state.hunger < 40) mood = "hungry";
                if(this.state.energy < 30) mood = "tired";

                const phrases = PHRASES[mood];
                const text = phrases[Math.floor(Math.random() * phrases.length)];
                
                this.speak(text);
                
                // Randomly show an emoji floater too
                if(Math.random() > 0.5) {
                    const emojis = ["â¤ï¸", "ğŸµ", "âœ¨", "â”", "ğŸ’¢"];
                    this.createFloatingText(emojis[Math.floor(Math.random()*emojis.length)], "pink");
                }
            }

            speak(text) {
                if(this.state.isSleeping) return;
                ui.chatBubble.innerText = text;
                ui.chatBubble.classList.add('show');
                
                // Hide after 3 seconds
                if(this.speakTimeout) clearTimeout(this.speakTimeout);
                this.speakTimeout = setTimeout(() => {
                    ui.chatBubble.classList.remove('show');
                }, 3000);
            }

            // The main heartbeat of the game
            tick() {
                if (this.state.isDead || this.state.inBattle) return;

                // Decay logic
                if (!this.state.isSleeping) {
                    this.state.hunger = Math.max(0, this.state.hunger - CONFIG.hungerDecay);
                    this.state.energy = Math.max(0, this.state.energy - CONFIG.energyDecay);
                }

                // Health penalties
                if (this.state.hunger <= 0) {
                    this.state.hp -= 2;
                    if(Math.random() < 0.1) this.speak("æˆ‘å¿«é¥¿æ™•äº†...");
                    this.log("è­¦å‘Šï¼šå® ç‰©æåº¦é¥¥é¥¿ï¼Œæ­£åœ¨æ‰£é™¤ç”Ÿå‘½å€¼ï¼", "red");
                }

                // Check death
                if (this.state.hp <= 0) {
                    this.die();
                }

                this.updateUI();
            }

            // Core Actions
            feed() {
                if (this.state.isSleeping) return;
                if (this.state.hunger >= 100) {
                    this.speak("åƒä¸ä¸‹äº†å•¦ï¼ğŸ¤¢");
                    this.log("å® ç‰©å·²ç»å¾ˆé¥±äº†ï¼");
                    return;
                }

                this.state.hunger = Math.min(100, this.state.hunger + 20);
                this.animatePet('anim-bounce');
                this.createFloatingText("ğŸ– +20", "orange");
                this.speak("çœŸå¥½åƒï¼ğŸ˜‹");

                // 5% Chance for Strength
                if (Math.random() < 0.05) {
                    this.state.strength += 1;
                    this.log("å¹¸è¿ï¼é£Ÿç‰©å¢å¼ºäº†å® ç‰©çš„åŠ›é‡ï¼", "yellow");
                    this.createFloatingText("ğŸ’ª STR UP!", "red");
                } else {
                    this.log("å–‚é£ŸæˆåŠŸã€‚");
                }
                this.updateUI();
            }

            train() {
                if (this.state.isSleeping) return;
                if (this.state.energy < 20) {
                    this.log("ç²¾åŠ›ä¸è¶³ï¼Œæ— æ³•è®­ç»ƒï¼è¯·å…ˆç¡è§‰ã€‚", "red");
                    this.animatePet('anim-shake');
                    return;
                }

                this.state.energy -= 20;
                this.addXP(10);
                this.createFloatingText("âš¡ -20", "yellow");
                this.log("è®­ç»ƒå®Œæˆï¼è·å¾—äº†ç»éªŒã€‚");
                this.updateUI();
            }

            sleep() {
                if (this.state.isSleeping || this.state.inBattle) return;

                this.state.isSleeping = true;
                this.log("å® ç‰©ç¡ç€äº†... zzz");
                this.speak("æ™šå®‰... Zzz ğŸ˜´");
                
                ui.sleepOverlay.classList.remove('hidden');
                ui.pet.classList.add('anim-sleep');
                this.toggleButtons(false);

                setTimeout(() => {
                    this.state.energy = 100;
                    this.state.hp = Math.min(this.state.maxHp, this.state.hp + 10);
                    this.state.isSleeping = false;
                    
                    ui.sleepOverlay.classList.add('hidden');
                    ui.pet.classList.remove('anim-sleep');
                    this.toggleButtons(true);
                    
                    this.log("å® ç‰©é†’æ¥äº†ï¼ç²¾åŠ›å……æ²›ï¼", "green");
                    this.speak("ç¡é¥±äº†ï¼å……æ»¡åŠ›é‡ï¼âš¡");
                    this.updateUI();
                }, CONFIG.sleepDuration);
            }

            startBattle() {
                if (this.state.isSleeping) return;
                if (this.state.energy < 30) {
                    this.log("ç²¾åŠ›ä¸è¶³ï¼Œæ— æ³•æˆ˜æ–—ï¼", "red");
                    this.animatePet('anim-shake');
                    return;
                }
                if (this.state.hp < 20) {
                    this.log("ç”Ÿå‘½å€¼å¤ªä½ï¼Œå¤ªå±é™©äº†ï¼", "red");
                    return;
                }

                this.state.energy -= 30;
                this.state.inBattle = true;
                this.speak(PHRASES.battle[Math.floor(Math.random()*PHRASES.battle.length)]);
                
                // Setup Battle UI
                ui.battleModal.classList.remove('hidden');
                ui.battleClose.classList.add('hidden');
                ui.battleLog.innerHTML = "";
                
                // Enemy Generation
                const enemyLevel = Math.max(1, this.state.level + Math.floor(Math.random() * 3) - 1);
                const enemyHpMax = 50 + (enemyLevel * 10);
                let enemy = {
                    name: "é‡ç”Ÿæ€ªå…½",
                    icon: ["ğŸ•·ï¸", "ğŸ¦‚", "ğŸ", "ğŸ¦‡", "ğŸº"][Math.floor(Math.random()*5)],
                    hp: enemyHpMax,
                    maxHp: enemyHpMax,
                    atk: 5 + (enemyLevel * 2)
                };

                document.getElementById('battle-player-icon').innerText = this.getPetEmoji();
                document.getElementById('battle-enemy-icon').innerText = enemy.icon;
                this.updateBattleHP(this.state.hp, this.state.maxHp, enemy.hp, enemy.maxHp);

                this.logBattle(`é­é‡äº† Lv.${enemyLevel} ${enemy.name}!`);

                // Battle Loop
                let turn = 0;
                const battleInterval = setInterval(() => {
                    turn++;
                    
                    // Player Turn
                    const dmgDealt = Math.floor((this.state.strength + (this.state.level * 2)) * (0.8 + Math.random() * 0.4));
                    enemy.hp -= dmgDealt;
                    this.logBattle(`ä½ å‘èµ·äº†æ”»å‡»ï¼Œé€ æˆ ${dmgDealt} ç‚¹ä¼¤å®³ï¼`, "green");
                    this.updateBattleHP(this.state.hp, this.state.maxHp, enemy.hp, enemy.maxHp);

                    if (enemy.hp <= 0) {
                        clearInterval(battleInterval);
                        this.endBattle(true);
                        return;
                    }

                    // Enemy Turn (Delayed slightly)
                    setTimeout(() => {
                        const dmgTaken = Math.floor(enemy.atk * (0.8 + Math.random() * 0.4));
                        this.state.hp -= dmgTaken;
                        this.logBattle(`æ•Œäººåå‡»ï¼ä½ å—åˆ° ${dmgTaken} ç‚¹ä¼¤å®³ï¼`, "red");
                        this.updateBattleHP(this.state.hp, this.state.maxHp, enemy.hp, enemy.maxHp);

                        if (this.state.hp <= 0) {
                            clearInterval(battleInterval);
                            this.state.hp = 0;
                            this.endBattle(false);
                        }
                    }, 500);

                }, 1500);
            }

            endBattle(win) {
                ui.battleClose.classList.remove('hidden');
                if (win) {
                    this.logBattle("ğŸ‰ æˆ˜æ–—èƒœåˆ©ï¼", "yellow");
                    this.addXP(40);
                    // Loot chance
                    if(Math.random() > 0.5) {
                        this.logBattle("è·å¾—äº†ç¾å‘³çš„æ ‘æœ (é¥±é£Ÿåº¦+10)!", "cyan");
                        this.state.hunger = Math.min(100, this.state.hunger + 10);
                    }
                } else {
                    this.logBattle("â˜ ï¸ æˆ˜æ–—å¤±è´¥...", "red");
                    this.logBattle("å® ç‰©å—é‡ä¼¤ï¼Œç»éªŒå€¼å‡åŠã€‚", "gray");
                    this.state.xp = Math.floor(this.state.xp / 2);
                }
                // Sync main UI hp
                this.updateUI();
            }

            endBattleUI() {
                ui.battleModal.classList.add('hidden');
                this.state.inBattle = false;
                // Check death after battle
                if(this.state.hp <= 0) this.die();
            }

            // Utilities
            addXP(amount) {
                this.state.xp += amount;
                this.createFloatingText(`XP +${amount}`, "purple");
                if (this.state.xp >= CONFIG.xpToLevel) {
                    this.levelUp();
                }
            }

            levelUp() {
                this.state.level++;
                this.state.xp = this.state.xp - CONFIG.xpToLevel;
                this.state.maxHp += 20;
                this.state.hp = this.state.maxHp;
                this.state.strength += 2;
                
                this.log(`å‡çº§äº†ï¼å½“å‰ç­‰çº§ Lv.${this.state.level}`, "gold");
                this.speak(PHRASES.evolve[Math.floor(Math.random()*PHRASES.evolve.length)]);
                ui.pet.classList.add('evolving');
                this.createFloatingText("LEVEL UP!", "gold");
                
                // Force UI update to show new emoji immediately
                this.updateUI();
                
                setTimeout(() => {
                    ui.pet.classList.remove('evolving');
                }, 2000);
            }

            getPetEmoji() {
                if (this.state.level < 4) return 'ğŸ¥š'; // Lv 1-3: Egg
                if (this.state.level < 8) return 'ğŸ£'; // Lv 4-7: Baby
                if (this.state.level < 12) return 'ğŸ¥'; // Lv 8-11: Teen
                if (this.state.level < 16) return 'ğŸ¦…'; // Lv 12-15: Adult
                return 'ğŸ”¥'; // Lv 16+: Phoenix/Legendary
            }
            
            getStageName() {
                if (this.state.level < 4) return 'å® ç‰©è›‹';
                if (this.state.level < 8) return 'å¹¼å¹´ä½“';
                if (this.state.level < 12) return 'æˆé•¿æœŸ';
                if (this.state.level < 16) return 'å®Œå…¨ä½“';
                return 'ç©¶æä½“';
            }
            
            getStageClass() {
                if (this.state.level < 4) return 'aura-stage-1';
                if (this.state.level < 8) return 'aura-stage-2';
                if (this.state.level < 12) return 'aura-stage-3';
                return 'aura-stage-4';
            }

            updateUI() {
                // Bars
                // Add null checks just in case, though they should be defined now
                if(ui.hpBar) ui.hpBar.style.width = `${(this.state.hp / this.state.maxHp) * 100}%`;
                if(ui.hpText) ui.hpText.innerText = Math.floor(this.state.hp);
                
                if(ui.hungerBar) ui.hungerBar.style.width = `${this.state.hunger}%`;
                if(ui.hungerText) ui.hungerText.innerText = Math.floor(this.state.hunger);
                
                if(ui.energyBar) ui.energyBar.style.width = `${this.state.energy}%`;
                if(ui.energyText) ui.energyText.innerText = Math.floor(this.state.energy);
                
                if(ui.xpBar) ui.xpBar.style.width = `${(this.state.xp / CONFIG.xpToLevel) * 100}%`;
                if(ui.xpText) ui.xpText.innerText = `${Math.floor(this.state.xp)}%`;

                // Text
                if(ui.level) ui.level.innerText = this.state.level;
                if(ui.stage) ui.stage.innerText = this.getStageName();
                if(ui.pet) {
                    ui.pet.innerText = this.getPetEmoji();
                    // Update Aura based on stage
                    ui.pet.className = `text-9xl cursor-pointer pet-container select-none transform transition-transform mt-8 ${this.getStageClass()}`;
                    // Dynamic Colors for high level
                    if (this.state.level >= 16) ui.pet.style.filter = "drop-shadow(0 0 25px orange)";
                }
            }

            updateBattleHP(pCur, pMax, eCur, eMax) {
                const pPct = Math.max(0, (pCur/pMax)*100);
                const ePct = Math.max(0, (eCur/eMax)*100);
                document.getElementById('battle-player-hp').style.width = `${pPct}%`;
                document.getElementById('battle-enemy-hp').style.width = `${ePct}%`;
            }

            die() {
                this.state.isDead = true;
                this.state.hp = 0;
                ui.deathModal.classList.remove('hidden');
                clearInterval(this.timer);
            }

            log(msg, color = "white") {
                const div = document.createElement('div');
                const time = new Date().toLocaleTimeString('zh-CN', { hour12: false, hour: '2-digit', minute:'2-digit', second:'2-digit' });
                div.innerHTML = `<span class="opacity-50">[${time}]</span> <span style="color:${color}">${msg}</span>`;
                ui.log.prepend(div);
            }

            logBattle(msg, color="white") {
                const div = document.createElement('div');
                div.innerHTML = `<span style="color:${color}">${msg}</span>`;
                ui.battleLog.appendChild(div);
                ui.battleLog.scrollTop = ui.battleLog.scrollHeight;
            }

            createFloatingText(text, color) {
                const el = document.createElement('div');
                el.className = `floater text-${color}-400 text-xl`;
                el.innerText = text;
                el.style.left = '50%';
                el.style.top = '50%';
                el.style.transform = 'translate(-50%, -50%)';
                ui.effects.appendChild(el);
                setTimeout(() => el.remove(), 1000);
            }

            toggleButtons(enable) {
                ui.buttons.forEach(btn => {
                    if (enable) btn.classList.remove('btn-disabled');
                    else btn.classList.add('btn-disabled');
                });
            }
        }

        // Initialize Game
        const game = new Game();

        // Simple interaction
        function petClick() {
            if(!game.state.isSleeping && !game.state.inBattle) {
                game.animatePet('anim-bounce');
                game.createFloatingText("â¤ï¸", "pink");
                
                // Random interaction speech
                const interactions = ["å˜¿å˜¿~", "æœ‰ç‚¹ç—’...", "å–œæ¬¢ä½ ï¼", "è¹­è¹­~"];
                game.speak(interactions[Math.floor(Math.random()*interactions.length)]);
            }
        }

        // Helper to trigger animations externally
        Game.prototype.animatePet = function(animClass) {
            ui.pet.classList.remove('anim-bounce', 'anim-shake');
            void ui.pet.offsetWidth; // trigger reflow
            ui.pet.classList.add(animClass);
        };
        
        function toggleSound() {
            // Sound placeholder - keeps the button visual but functional logic would go here
            game.log("é™éŸ³æ¨¡å¼å·²åˆ‡æ¢");
        }

    </script>
</body>
</html>